<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Bus Routes | UJI</title>

  <!-- Bootstrap -->
  <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css"> -->

  <link href="css/bootstrap.css" rel="stylesheet">
  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  <link rel="stylesheet" href="http://serverapi.arcgisonline.com/jsapi/arcgis/3.3/js/dojo/dijit/themes/soria/soria.css">
  <link rel="stylesheet" href="http://serverapi.arcgisonline.com/jsapi/arcgis/3.3/js/esri/css/esri.css">


  <!-- Load Leaflet from CDN-->
  <link rel="stylesheet" href="//cdn.jsdelivr.net/leaflet/0.7.3/leaflet.css" />
  <link rel="stylesheet" href="http://code.ionicframework.com/ionicons/1.5.2/css/ionicons.min.css">
  <link rel="stylesheet" href="css/leaflet.awesome-markers.css">



  <style>
    body {
      margin: 0;
      padding: 0;
    }
    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      right: 0;
      left: 0;
    }
    #map {
      position: absolute;
      height: 100%;
      width: 100%;
    }
    #zoomControls {
      position: absolute;
      right: 20px;
      top: 10px;
      z-index: 3;
    }
    #logo {
      position: absolute;
      z-index: 3;
      left: 20px;
      bottom: 10px;
    }
    #logo img {
      width: 45px;
    }
    #routes-list {
      margin-top: 10px;
    }
    #routes-list li a {
      padding: 5px 15px;
    }
  </style>


  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->


  <!-- dojo -->



</head>

<body>
  <div id="map">

    <div id="logo">
      <img src="images/logo.png" />
    </div>
  </div>
  <div class="container-fluid">
    <div class="row">.</div>
    <div class="row">
      <div class="col-md-3">
        <div class="panel panel-default">
          <div class="panel-body">
            <!-- option -->
            <div role="tabpanel">

              <ul class="nav nav-pills" role="tablist">
                <li role="presentation" class="active"><a data-toggle="pill" href="#routes">Bus Routes</a>
                </li>
                <!-- <li role="presentation" class=""><a data-toggle="pill" href="#direction">Directions</a>
                </li> -->


              </ul>


              <!-- Tab panes -->
              <div class="tab-content">
                <div role="tabpanel" class="tab-pane active" id="routes">
                  <ul id="routes-list" class="nav nav-pills nav-stacked">
                    <li class=" bus_line " data-line-number="18"> <a href="#"><i class="fa fa-bus"></i> Line 1</a>
                    </li>
                    <li class=" bus_line " data-line-number="19"> <a href="#"><i class="fa fa-bus"></i> Line 2</a>
                    </li>
                    <li class=" bus_line " data-line-number="20"> <a href="#"><i class="fa fa-bus"></i> Line 3 </a>
                    </li>
                    <li class=" bus_line " data-line-number="21"> <a href="#"><i class="fa fa-bus"></i> Line 4</a>
                    </li>
                    <li class=" bus_line " data-line-number="22"> <a href="#"><i class="fa fa-bus"></i> Line 5</a>
                    </li>
                    <li class=" bus_line " data-line-number="23"> <a href="#"><i class="fa fa-bus"></i> Line 6</a>
                    </li>
                    <li class=" bus_line " data-line-number="24"> <a href="#"><i class="fa fa-bus"></i> Line 7</a>
                    </li>
                    <li class=" bus_line " data-line-number="25"> <a href="#"><i class="fa fa-bus"></i> Line 8</a>
                    </li>
                    <li class=" bus_line " data-line-number="26"> <a href="#"><i class="fa fa-bus"></i> Line 9</a>
                    </li>
                    <li class=" bus_line " data-line-number="27"> <a href="#"><i class="fa fa-bus"></i> Line 10</a>
                    </li>
                    <li class=" bus_line " data-line-number="28"> <a href="#"><i class="fa fa-bus"></i> Line 11</a>
                    </li>
                    <li class=" bus_line " data-line-number="29"> <a href="#"><i class="fa fa-bus"></i> Line 12</a>
                    </li>
                    <li class=" bus_line " data-line-number="30"> <a href="#"><i class="fa fa-bus"></i> Line 13</a>
                    </li>
                    <li class=" bus_line " data-line-number="31"> <a href="#"><i class="fa fa-bus"></i> Line 15</a>
                    </li>
                    <li class=" bus_line " data-line-number="32"> <a href="#"><i class="fa fa-bus"></i> Line 16</a>
                    </li>
                    <li class=" bus_line " data-line-number="33"> <a href="#"><i class="fa fa-bus"></i> Line 17</a>
                    </li>
                  </ul>
                </div>

                <div class="btn-group pull-right" role="group" aria-label="...">
                  <button type="button" class="btn btn-default" id="allBus"><i class="fa fa-check"></i> All</button>
                  <button type="button" class="btn btn-info" id="clearBus"><i class="fa fa-trash-o"></i> Clear</button>
                </div>

              </div>
              <div role="tabpanel" class="tab-pane" id="direction"></div>

            </div>
          </div>


        </div>
      </div>
    </div>
  </div>
  </div>

  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>

  <script src="http://cdn.jsdelivr.net/leaflet/0.7.3/leaflet.js"></script>
  <script src="js/AnimatedMarker.js"></script>
  <script src="js/leaflet.awesome-markers.min.js"></script>
  <script src="js/Leaflet.MakiMarkers.js"></script>


  <!-- Load Esri Leaflet from CDN -->
  <script src="http://cdn-geoweb.s3.amazonaws.com/esri-leaflet/1.0.0-rc.5/esri-leaflet.js"></script>



  <script>
    var busLinesLayes = [18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33];
    var busStationsLayes = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16];
    var colors = ['#fe0002', '#ff6600', '#948953', '#807f00', '#ffa500', '#00af50', '#008102', '#92d14f', '#026fc1', '#33a09c', '#fd349a', '#96b4d8', '#943636', '#943636', '#ffc000', '#6f31a0'];
    var activeLayers = [];
    var featureLayers = [];
    var markers = [];
    var line;


    var map = L.map('map', {
      zoomControl: false
    }).setView([39.9859663, -0.0416723], 15);
    new L.Control.Zoom({
      position: 'bottomright'
    }).addTo(map);

    L.esri.basemapLayer('Streets').addTo(map);
    //var dynamicMapLayer = L.esri.dynamicMapLayer('http://mastergeotech.dlsi.uji.es:6080/arcgis/rest/services/al309735/UJI_Bus/MapServer/').addTo(map);

    $.each(busLinesLayes, function(index, item) {
      console.log(colors[index]);
      featureLayers[item] = L.esri.featureLayer('http://mastergeotech.dlsi.uji.es:6080/arcgis/rest/services/al309735/UJI_Bus/MapServer/' + item, {
        weight: 5,
        opacity: 0.5,
        color: colors[index]
      });
    });

    $.each(busStationsLayes, function(index, item) {
      featureLayers[item] = L.esri.featureLayer('http://mastergeotech.dlsi.uji.es:6080/arcgis/rest/services/al309735/UJI_Bus/MapServer/' + item, {
        opacity: 0.5,
        color: colors[index],
        pointToLayer: function(geojson, latlng) {
          // console.log(geojson);
          station = geojson.properties;

          return L.marker(latlng, {
            icon: L.icon({
              iconUrl: 'http://esri.github.io/esri-leaflet/img/bus-stop.png',
              iconRetinaUrl: 'http://esri.github.io/esri-leaflet/img/bus-stop.png',
              iconSize: [16, 16],
              iconAnchor: [17.5, 13.5],
              popupAnchor: [0, -11],
            })
          }).bindPopup("<b>"+station.address+"</b><br />" + station.nextbuses.replace(/[;#]/g,'<br />'));
        },

      });
    });


    // {
    //   onEachFeature: function(feature){
    //     console.log(feature.geometry.coordinates);
    //     line = L.LineUtil.simplify(feature.geometry.coordinates);
    //     console.log(line);
    //   }




    map.on('click', function(event) {
      console.log(line);
      //    var mline = L.polyline(line.slice(0,100));
      //  animatedMarker = L.animatedMarker(mline.getLatLngs());
      // //
      //  map.addLayer(animatedMarker);

      //
      // console.log(line);
      //
      // mm = L.polyline([[-0.056336,39.974864], [-0.05559,39.97453]]);
      // var mline = L.polyline(mm),
      //  animatedMarker = L.animatedMarker(mline.getLatLngs());
      // //
      // map.addLayer(animatedMarker);
      // bus1.eachFeature(function(layer){
      //   console.log(layer.feature.properties.NAME);
      // });
    })



    $(document).ready(function() {


      $('.bus_line ').click(function() {

        var line_number = $(this).data("line-number");
        var bus_stations = line_number - 17;
        // chnageLayerVisible(line_number);

        if (!$(this).hasClass('active')) {
          activeLayers.push(line_number);
          activeLayers.push(bus_stations);
          featureLayers[line_number].addTo(map);
          featureLayers[bus_stations].addTo(map);

          console.log(featureLayers[line_number]);

          featureLayers[line_number].eachFeature(function(a, b) {
            console.log(b);
          });

          featureLayers[line_number].query().where("1=1").run(function(error, featureCollection, response) {
            var line = featureCollection.features[0].geometry.coordinates;

            $.each(line, function(index, item) {
              var x = item[0];
              item[0] = item[1];
              item[1] = x;
            });

            var pline = L.polyline(line);
            markers[line_number] = L.animatedMarker(pline.getLatLngs(), {
              icon: L.MakiMarkers.icon({
                icon: "bus",
                color: colors[line_number - 18],
                size: "m",
                draggable: true
              }),
              distance: 2, // meters
              interval: 200, // milliseconds
            }).bindPopup("ssss");
            markers[line_number].bindPopup("I am a circle.");
            map.addLayer(markers[line_number]);
          });

          $(this).addClass('active');



        } else {
          featureLayers[line_number].removeFrom(map);
          featureLayers[bus_stations].removeFrom(map);
          // map.removeLayer(animatedMarker);
          map.removeLayer(markers[line_number]);
          $(this).removeClass('active');

          var i = activeLayers.indexOf(line_number);
          if (i != -1) {
            activeLayers.splice(i, 1);
          }

          var i = activeLayers.indexOf(bus_stations);
          if (i != -1) {
            activeLayers.splice(i, 1);
          }
        }

        //alert(attr(signal,'line-number'));
        //featureLayer.setVisibleLayers(activeLayers);
      });

      $('#clearBus').click(function(){
        $('.bus_line.active').click();
      })

      $('#allBus').click(function(){
        $('.bus_line').click();
      })


    });
  </script>

</body>

</html>
